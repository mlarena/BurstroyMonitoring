@model IEnumerable<BurstroyMonitoring.Data.Models.VwDovDataFull>
@using BurstroyMonitoring.Data.Models.ViewModels
@{
    ViewData["Title"] = "–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö DOV";
    var filter = ViewBag.Filter as DataFilterViewModel ?? new DataFilterViewModel();
    var availableFields = ViewBag.AvailableFields as List<string> ?? new List<string>();
    var serialNumbers = ViewBag.SerialNumbers as List<string> ?? new List<string>();
    var endpointNames = ViewBag.EndpointNames as List<string> ?? new List<string>();
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var displayedCount = Model.Count();
    
    // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π
    var fieldDisplayNames = new Dictionary<string, string>
    {
        ["DovDataId"] = "ID –¥–∞–Ω–Ω—ã—Ö",
        ["ReceivedAt"] = "–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è",
        ["DataTimestamp"] = "–ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏",
        ["VisibleRange"] = "–í–∏–¥–∏–º–∞—è –¥–∞–ª—å–Ω–æ—Å—Ç—å",
        ["BrightFlag"] = "–§–ª–∞–≥ —è—Ä–∫–æ—Å—Ç–∏",
        ["SensorLongitude"] = "–î–æ–ª–≥–æ—Ç–∞ –¥–∞—Ç—á–∏–∫–∞",
        ["SensorLatitude"] = "–®–∏—Ä–æ—Ç–∞ –¥–∞—Ç—á–∏–∫–∞",
        ["SerialNumber"] = "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä",
        ["EndpointName"] = "–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞",
        ["SensorUrl"] = "URL –¥–∞—Ç—á–∏–∫–∞",
        ["CheckIntervalSeconds"] = "–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫)",
        ["LastActivityUtc"] = "–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        ["SensorIsActive"] = "–î–∞—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω",
        ["SensorTypeName"] = "–¢–∏–ø –¥–∞—Ç—á–∏–∫–∞",
        ["SensorTypeDescription"] = "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞",
        ["PostName"] = "–ò–º—è –ø–æ—Å—Ç–∞",
        ["PostDescription"] = "–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—Ç–∞",
        ["PostIsMobile"] = "–ú–æ–±–∏–ª—å–Ω—ã–π –ø–æ—Å—Ç",
        ["PostIsActive"] = "–ü–æ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω"
    };
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º availableFields —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ—Ä—è–¥–∫—É –≤ fieldDisplayNames
    var sortedFields = availableFields
        .OrderBy(f => fieldDisplayNames.ContainsKey(f) 
            ? Array.IndexOf(fieldDisplayNames.Keys.ToArray(), f) 
            : int.MaxValue)
        .ToList();
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    var appliedFilters = new List<string>();
    
    if (filter.StartDate.HasValue)
    {
        appliedFilters.Add($"–°: {filter.StartDate.Value.ToString("dd.MM.yyyy HH:mm")}");
    }
    
    if (filter.EndDate.HasValue)
    {
        appliedFilters.Add($"–ü–æ: {filter.EndDate.Value.ToString("dd.MM.yyyy HH:mm")}");
    }
    
    if (!string.IsNullOrEmpty(filter.SerialNumber))
    {
        appliedFilters.Add($"–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ: {filter.SerialNumber}");
    }
    
    if (!string.IsNullOrEmpty(filter.EndpointName))
    {
        appliedFilters.Add($"–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞: {filter.EndpointName}");
    }
    
    if (filter.SensorIsActive.HasValue)
    {
        appliedFilters.Add($"–î–∞—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω: {(filter.SensorIsActive.Value ? "–î–∞" : "–ù–µ—Ç")}");
    }
    
    if (filter.PostIsActive.HasValue)
    {
        appliedFilters.Add($"–ü–æ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω: {(filter.PostIsActive.Value ? "–î–∞" : "–ù–µ—Ç")}");
    }
    
    if (!string.IsNullOrEmpty(filter.PageSize))
    {
        var pageSizeText = filter.PageSize == "all" ? "–í—Å—ë" : $"–ü–µ—Ä–≤—ã–µ {filter.PageSize}";
        appliedFilters.Add($"–í—ã–≤–æ–¥–∏—Ç—å: {pageSizeText}");
    }
    
    var appliedFiltersText = appliedFilters.Any() ? string.Join("; ", appliedFilters) : "–§–∏–ª—å—Ç—Ä—ã –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã";
}

<div class="main-content">
    <div class="view-container">
        <h1 class="view-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö DOV</h1>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success m-2">
                <div class="alert-content">
                    @TempData["Message"]
                    <button type="button" class="alert-close" onclick="this.parentElement.parentElement.style.display='none'">√ó</button>
                </div>
            </div>
        }
        
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-error m-2">
                <div class="alert-content">
                    @TempData["ErrorMessage"]
                    <button type="button" class="alert-close" onclick="this.parentElement.parentElement.style.display='none'">√ó</button>
                </div>
            </div>
        }
        
        <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="filter-container m-2">
            <div class="filter-header d-flex align-center justify-between cursor-pointer" id="filterHeader">
                <div class="d-flex align-center gap-2">
                    <div class="filter-toggle-icon">
                        <svg id="filterToggleIcon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path id="filterTogglePath" d="M12 5L8 9L4 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        </svg>
                    </div>
                    <h3 class="filter-title m-0">–§–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                </div>
                <div class="applied-filters-text text-muted" id="appliedFiltersText">
                    @appliedFiltersText
                </div>
            </div>
            
            <div class="filter-content" id="filterContent">
                <form method="get" id="filterForm" class="filter-form mt-3">
                    <!-- –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
                    <div class="form-row d-flex align-end gap-2">
                        <!-- –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ -->
                        <div class="field-group" style="width: 180px;">
                            <label class="control-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="datetime-local" class="input" name="StartDate" 
                                   value="@(filter.StartDate?.ToString("yyyy-MM-ddTHH:mm"))">
                        </div>
                        
                        <!-- –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ -->
                        <div class="field-group" style="width: 180px;">
                            <label class="control-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                            <input type="datetime-local" class="input" name="EndDate" 
                                   value="@(filter.EndDate?.ToString("yyyy-MM-ddTHH:mm"))">
                        </div>
                        
                        <!-- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä -->
                        <div class="field-group" style="width: 200px;">
                            <label class="control-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                            <select class="input select" name="SerialNumber">
                                <option value="">–í—Å–µ</option>
                                @foreach (var serial in serialNumbers)
                                {
                                    <option value="@serial" selected="@(serial == filter.SerialNumber)">@serial</option>
                                }
                            </select>
                        </div>
                        
                        <!-- –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ -->
                        <div class="field-group" style="width: 200px;">
                            <label class="control-label">–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</label>
                            <select class="input select" name="EndpointName">
                                <option value="">–í—Å–µ</option>
                                @foreach (var endpoint in endpointNames)
                                {
                                    <option value="@endpoint" selected="@(endpoint == filter.EndpointName)">@endpoint</option>
                                }
                            </select>
                        </div>
                        
                        <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –¥–∞—Ç—á–∏–∫ -->
                        <div class="field-group" style="width: 150px;">
                            <label class="control-label">–ê–∫—Ç–∏–≤–Ω—ã–π –¥–∞—Ç—á–∏–∫</label>
                            <select class="input select" name="SensorIsActive">
                                <option value="">–í—Å–µ</option>
                                <option value="true" selected="@(filter.SensorIsActive == true)">–î–∞</option>
                                <option value="false" selected="@(filter.SensorIsActive == false)">–ù–µ—Ç</option>
                            </select>
                        </div>
                        
                        <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç -->
                        <div class="field-group" style="width: 150px;">
                            <label class="control-label">–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç</label>
                            <select class="input select" name="PostIsActive">
                                <option value="">–í—Å–µ</option>
                                <option value="true" selected="@(filter.PostIsActive == true)">–î–∞</option>
                                <option value="false" selected="@(filter.PostIsActive == false)">–ù–µ—Ç</option>
                            </select>
                        </div>
                        
                        <!-- –í—ã–≤–æ–¥–∏—Ç—å –ø–æ -->
                        <div class="field-group" style="width: 150px;">
                            <label class="control-label">–í—ã–≤–æ–¥–∏—Ç—å –ø–æ</label>
                            <select class="input select" name="PageSize">
                                <option value="10" selected="@(filter.PageSize == "10")">–ü–µ—Ä–≤—ã–µ 10</option>
                                <option value="100" selected="@(filter.PageSize == "100")">–ü–µ—Ä–≤—ã–µ 100</option>
                                <option value="all" selected="@(filter.PageSize == "all" || filter.PageSize == "–≤—Å—ë")">–í—Å—ë (@totalCount)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä –ø–æ–ª–µ–π -->
                    <div class="field-group mt-3">
                        <label class="control-label mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                        
                        <div class="checkbox-group-header mb-2">
                            <div class="checkbox-item">
                                <input type="checkbox" id="selectAllFields" class="checkbox-input">
                                <label for="selectAllFields" class="checkbox-label" id="selectAllLabel">
                                    <span class="checkbox-custom"></span>
                                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                </label>
                            </div>
                        </div>
                        
                        <div class="fields-grid" id="fieldsContainer">
                            @{
                                int columnCount = 4;
                                // –†–∞–∑–±–∏–≤–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
                                int itemsPerColumn = (int)Math.Ceiling((double)sortedFields.Count / columnCount);
                                var fieldColumns = new List<List<string>>();
                                
                                for (int i = 0; i < columnCount; i++)
                                {
                                    fieldColumns.Add(new List<string>());
                                }
                                
                                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É (—Å–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü, –ø–æ—Ç–æ–º –≤—Ç–æ—Ä–æ–π –∏ —Ç.–¥.)
                                for (int i = 0; i < sortedFields.Count; i++)
                                {
                                    int columnIndex = i / itemsPerColumn;
                                    if (columnIndex < columnCount)
                                    {
                                        fieldColumns[columnIndex].Add(sortedFields[i]);
                                    }
                                }
                            }
                            
                            <div class="fields-table d-flex gap-3">
                                @for (int col = 0; col < columnCount; col++)
                                {
                                    <div class="fields-column @(col < columnCount - 1 ? "column-with-border" : "")">
                                        @foreach (var field in fieldColumns[col])
                                        {
                                            <div class="checkbox-item">
                                                <input type="checkbox" class="checkbox-input field-checkbox" 
                                                       name="SelectedFields" value="@field" 
                                                       id="field_@field"
                                                       @(filter.SelectedFields.Contains(field) ? "checked" : "")>
                                                <label for="field_@field" class="checkbox-label" title="@field">
                                                    <span class="checkbox-custom"></span>
                                                    @{
                                                        var displayName = fieldDisplayNames.ContainsKey(field) 
                                                            ? fieldDisplayNames[field] 
                                                            : field;
                                                    }
                                                    @displayName
                                                </label>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="form-actions mt-3">
                        <button type="submit" class="button button--primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                        <a href="@Url.Action("Reset")" class="button button--secondary">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</a>
                        <a href="@Url.Action("DataViewer")" class="button button--secondary">–û–±–Ω–æ–≤–∏—Ç—å</a>
                        
                        <div class="records-info ml-auto">
                            –ü–æ–∫–∞–∑–∞–Ω–æ: @displayedCount –∏–∑ @totalCount –∑–∞–ø–∏—Å–µ–π
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
        <div class="card m-2">
            <div class="card-header">
                <h3 class="card-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            </div>
            <div class="card-body">
                <form method="post" asp-action="Export" id="exportForm">
                    <input type="hidden" name="StartDate" value="@filter.StartDate" />
                    <input type="hidden" name="EndDate" value="@filter.EndDate" />
                    <input type="hidden" name="SerialNumber" value="@filter.SerialNumber" />
                    <input type="hidden" name="EndpointName" value="@filter.EndpointName" />
                    <input type="hidden" name="SensorIsActive" value="@filter.SensorIsActive" />
                    <input type="hidden" name="PostIsActive" value="@filter.PostIsActive" />
                    <input type="hidden" name="PageSize" value="@filter.PageSize" />
                    
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π -->
                    <div id="hiddenFields">
                        @foreach (var field in filter.SelectedFields)
                        {
                            <input type="hidden" name="SelectedFields" value="@field" />
                        }
                    </div>
                    
                    <div class="export-actions d-flex align-center justify-between mt-2">
                        <div class="export-buttons d-flex gap-2">
                            <button type="submit" name="format" value="excel" class="button button--success">
                                <span class="button-icon excel-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V17H2.83Q2.5 17 2.24 16.76 2 16.5 2 16.17V7.83Q2 7.5 2.24 7.24 2.5 7 2.83 7H7V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25M7 13.06L8.18 15.28H9.97L8 12.06L9.93 8.89H8.22L7 10.9L5.82 8.89H4.09L6 12.06L4 15.28H5.81M20.75 19.5V17H8.25V19.5M20.75 15.75V12.63H12V15.75M20.75 11.38V8.25H12V11.38M20.75 7V4.5H8.25V7Z"/>
                                    </svg>
                                </span>
                                –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                            </button>
                            <button type="submit" name="format" value="csv" class="button button--info">
                                <span class="button-icon">üìã</span>
                                –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                            </button>
                        </div>
                        
                        <div class="export-option">
                            <label class="checkbox-item" style="margin: 0;">
                                <input type="checkbox" id="exportAllData" name="ExportAllData" value="true" class="checkbox-input">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç "–í—ã–≤–æ–¥–∏—Ç—å –ø–æ")</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="m-2">
            <div class="table-header">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                <span class="records-count">(@displayedCount –∑–∞–ø–∏—Å–µ–π)</span>
            </div>
            
            <div class="table-responsive">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
                <div class="overflow-x-auto" id="tableHeaderScroll">
                    <table class="table table-bordered">
                        <thead>
                           <tr>
                                @{
                                    int fieldIndex = 0;
                                    foreach (var field in filter.SelectedFields)
                                    {
                                        var displayName = fieldDisplayNames.ContainsKey(field) 
                                            ? fieldDisplayNames[field] 
                                            : field;
                                        var cellClass = fieldIndex < filter.SelectedFields.Count() - 1 ? "cell-with-border" : "";
                                        <th class="@cellClass" style="min-width: 150px; white-space: nowrap;">@displayName</th>
                                        fieldIndex++;
                                    }
                                }
                            </tr>
                        </thead>
                    </table>
                </div>
                
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
                <div class="overflow-x-auto" id="tableBodyScroll" style="max-height: 600px;">
                    <table class="table table-bordered">
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    @{
                                        int cellIndex = 0;
                                        foreach (var field in filter.SelectedFields)
                                        {
                                            var cellClass = cellIndex < filter.SelectedFields.Count() - 1 ? "cell-with-border" : "";
                                            <td class="@cellClass" style="min-width: 150px;">@GetPropertyValue(item, field)</td>
                                            cellIndex++;
                                        }
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[JS] –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            // 1. –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filterHeader = document.getElementById('filterHeader');
            const filterContent = document.getElementById('filterContent');
            const filterToggleIcon = document.getElementById('filterToggleIcon');
            const filterTogglePath = document.getElementById('filterTogglePath');
            const appliedFiltersText = document.getElementById('appliedFiltersText');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
            const isFilterCollapsed = localStorage.getItem('filterCollapsed') === 'true';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (isFilterCollapsed) {
                filterContent.classList.add('collapsed');
                filterToggleIcon.classList.add('collapsed');
                filterTogglePath.setAttribute('d', 'M4 8L8 4L12 8'); // –ò–∫–æ–Ω–∫–∞ –≤–ø—Ä–∞–≤–æ
                appliedFiltersText.style.display = 'block';
            } else {
                appliedFiltersText.style.display = 'none';
            }
            
            filterHeader.addEventListener('click', function() {
                const isCollapsed = filterContent.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    filterContent.classList.remove('collapsed');
                    filterToggleIcon.classList.remove('collapsed');
                    filterTogglePath.setAttribute('d', 'M12 5L8 9L4 5'); // –ò–∫–æ–Ω–∫–∞ –≤–Ω–∏–∑
                    appliedFiltersText.style.display = 'none';
                    localStorage.setItem('filterCollapsed', 'false');
                } else {
                    // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    filterContent.classList.add('collapsed');
                    filterToggleIcon.classList.add('collapsed');
                    filterTogglePath.setAttribute('d', 'M4 8L8 4L12 8'); // –ò–∫–æ–Ω–∫–∞ –≤–ø—Ä–∞–≤–æ
                    appliedFiltersText.style.display = 'block';
                    localStorage.setItem('filterCollapsed', 'true');
                }
            });
            
            // 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π —Ç–∞–±–ª–∏—Ü
            const headerScroll = document.getElementById('tableHeaderScroll');
            const bodyScroll = document.getElementById('tableBodyScroll');
            
            if (headerScroll && bodyScroll) {
                headerScroll.addEventListener('scroll', function() {
                    bodyScroll.scrollLeft = headerScroll.scrollLeft;
                });
                
                bodyScroll.addEventListener('scroll', function() {
                    headerScroll.scrollLeft = bodyScroll.scrollLeft;
                });
            }
            
            // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            const selectAllCheckbox = document.getElementById('selectAllFields');
            const selectAllLabel = document.getElementById('selectAllLabel');
            const fieldCheckboxes = document.querySelectorAll('.field-checkbox');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
            function updateSelectAllText() {
                const allChecked = Array.from(fieldCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(fieldCheckboxes).some(cb => cb.checked);
                
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                if (allChecked) {
                    selectAllLabel.textContent = '–°–Ω—è—Ç—å –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è';
                } else {
                    selectAllLabel.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateSelectAllText();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                console.log(`[JS] –í—ã–±—Ä–∞—Ç—å –≤—Å–µ: ${isChecked}`);
                
                fieldCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                
                updateSelectAllText(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                updateHiddenFields();
            });
            
            // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
            fieldCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log(`[JS] –ò–∑–º–µ–Ω–µ–Ω —á–µ–∫–±–æ–∫—Å: ${this.value} = ${this.checked}`);
                    updateSelectAllText(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    updateHiddenFields();
                });
            });
            
            // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
            function updateHiddenFields() {
                const hiddenFieldsContainer = document.getElementById('hiddenFields');
                hiddenFieldsContainer.innerHTML = '';
                
                const checkedBoxes = document.querySelectorAll('.field-checkbox:checked');
                console.log(`[JS] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π, –≤—ã–±—Ä–∞–Ω–æ: ${checkedBoxes.length}`);
                
                checkedBoxes.forEach(checkbox => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'SelectedFields';
                    hiddenInput.value = checkbox.value;
                    hiddenFieldsContainer.appendChild(hiddenInput);
                });
            }
            
            // 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportForm = document.getElementById('exportForm');
            const exportAllCheckbox = document.getElementById('exportAllData');
            
            if (exportForm) {
                exportForm.addEventListener('submit', function(e) {
                    const checkedBoxes = document.querySelectorAll('.field-checkbox:checked');
                    console.log(`[JS] –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–æ—Ä—Ç–∞, –≤—ã–±—Ä–∞–Ω–æ –ø–æ–ª–µ–π: ${checkedBoxes.length}`);
                    
                    if (checkedBoxes.length === 0) {
                        e.preventDefault();
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                        console.log('[JS] –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω–µ–Ω: –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –ø–æ–ª—è');
                        return false;
                    }
                    
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ"
                    if (exportAllCheckbox && exportAllCheckbox.checked) {
                        console.log('[JS] –≠–∫—Å–ø–æ—Ä—Ç –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö (–∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø–∞–≥–∏–Ω–∞—Ü–∏—é)');
                    }
                    
                    console.log('[JS] –§–æ—Ä–º–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...');
                    return true;
                });
            }
            
            // 7. –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
            fieldCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    setTimeout(saveFilterToSession, 500);
                });
            });
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ–ª–µ–∫—Ç–∞—Ö —Ç–æ–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    setTimeout(saveFilterToSession, 500);
                });
            });
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ –¥–∞—Ç
            document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
                input.addEventListener('change', function() {
                    setTimeout(saveFilterToSession, 500);
                });
            });
            
            function saveFilterToSession() {
                const formData = new FormData(document.getElementById('filterForm'));
                const selectedFields = [];
                
                document.querySelectorAll('.field-checkbox:checked').forEach(cb => {
                    selectedFields.push(cb.value);
                });
                
                fetch('@Url.Action("SaveFilter", "DovData")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        StartDate: formData.get('StartDate'),
                        EndDate: formData.get('EndDate'),
                        SerialNumber: formData.get('SerialNumber'),
                        EndpointName: formData.get('EndpointName'),
                        SensorIsActive: formData.get('SensorIsActive'),
                        PostIsActive: formData.get('PostIsActive'),
                        PageSize: formData.get('PageSize'),
                        SelectedFields: selectedFields
                    })
                }).then(response => {
                    if (response.ok) {
                        console.log('[JS] –§–∏–ª—å—Ç—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Å–µ—Å—Å–∏–∏');
                    }
                });
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateHiddenFields();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
            setTimeout(() => {
                const headerTable = headerScroll ? headerScroll.querySelector('table') : null;
                if (headerTable) {
                    headerTable.style.visibility = 'visible';
                }
            }, 100);
        });
    </script>
}

@functions {
    public string GetPropertyValue(VwDovDataFull item, string propertyName)
    {
        var property = item.GetType().GetProperty(propertyName);
        if (property == null) return "";
        
        var value = property.GetValue(item);
        
        // –û—Å–æ–±—ã–π —Å–ª—É—á–∞–π –¥–ª—è BrightFlag
        if (propertyName == "BrightFlag" && value is int intValue)
        {
            return intValue == 1 ? "–î–∞" : intValue == 0 ? "–ù–µ—Ç" : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
        if (value is DateTime dateTimeValue)
        {
            return dateTimeValue.ToString("dd.MM.yyyy HH:mm");
        }
        
        // –î–ª—è –±—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        if (value is bool boolValue)
        {
            return boolValue ? "–î–∞" : "–ù–µ—Ç";
        }
        
        // –î–ª—è NULL –∑–Ω–∞—á–µ–Ω–∏–π
        if (value == null)
        {
            return "";
        }
        
        return value.ToString();
    }
}