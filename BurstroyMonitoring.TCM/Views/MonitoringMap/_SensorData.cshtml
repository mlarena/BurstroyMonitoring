@model dynamic

@{
    var sensorTypeId = ViewBag.SensorTypeId as int?;
    var sensorId = ViewBag.SensorId as int?;
    var sensorName = ViewBag.SensorName as string ?? "Датчик";
    
    // Преобразуем dynamic в Dictionary для удобства
    var data = new Dictionary<string, object>();
    if (Model != null)
    {
        var properties = Model.GetType().GetProperties();
        foreach (var prop in properties)
        {
            var value = prop.GetValue(Model);
            if (value != null)
            {
                data[prop.Name] = value;
            }
        }
    }
}

<style>
    .sensor-data-content {
        padding: 0 !important;
        max-height: 250px;
        overflow-y: auto;
        background: white;
    }
    
    .sensor-data-container {
        width: 100%;
        overflow-x: auto;
        background: white;
    }
    
    .sensor-data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 800px;
        border: none;
    }
    
    .sensor-data-table td {
        padding: 10px 12px;
        border: 1px solid #e9ecef;
        vertical-align: middle;
    }
    
    .parameters-row td {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
        text-align: center;
    }
    
    .values-row td {
        font-family: 'Courier New', monospace;
        font-weight: 500;
        text-align: center;
        background-color: white;
    }
    
    .values-row td.number {
        color: #28a745;
    }
    
    .values-row td.boolean {
        color: #dc3545;
    }
    
    .values-row td.string {
        color: #17a2b8;
    }
    
    .values-row td.datetime {
        color: #6f42c1;
    }
    
    .no-data-message {
        padding: 30px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    .no-data-message i {
        font-size: 24px;
        margin-bottom: 10px;
        color: #adb5bd;
    }
</style>

@if (data.Any())
{
    @* Получаем временную метку для передачи в заголовок *@
    var timestamp = data.FirstOrDefault(x => 
        x.Key == "ReceivedAt" || 
        x.Key == "receivedAt" || 
        x.Key == "DataTimestamp" || 
        x.Key == "dataTimestamp").Value;
    
    string timestampStr = "";
    if (timestamp != null)
    {
        if (timestamp is DateTime dt)
        {
            timestampStr = dt.ToString("dd.MM.yyyy HH:mm:ss");
        }
        else
        {
            timestampStr = timestamp.ToString() ?? "";
        }
    }
    
    @* Сохраняем временную метку в ViewBag для заголовка *@
    ViewBag.Timestamp = timestampStr;
    
    @* Фильтруем параметры для отображения (исключаем ID и временные метки) *@
    var displayParams = data.Where(x => 
        !x.Key.Contains("ReceivedAt") && 
        !x.Key.Contains("DataTimestamp") && 
        !x.Key.Contains("received") && 
        !x.Key.Contains("timestamp") &&
        !x.Key.Contains("Id") && 
        !x.Key.Contains("SensorId") && 
        !x.Key.Contains("id") && 
        !x.Key.Contains("sensor_id")).ToList();
    
    <div class="sensor-data-container">
        <table class="sensor-data-table">
            @* Строка с названиями параметров *@
            <tr class="parameters-row">
                @foreach (var item in displayParams)
                {
                    <td>@item.Key</td>
                }
            </tr>
            
            @* Строка со значениями *@
            <tr class="values-row">
                @foreach (var item in displayParams)
                {
                    string displayValue = item.Value?.ToString() ?? "-";
                    string valueClass = "";
                    
                    // Форматирование значений
                    if (item.Value is DateTime dt)
                    {
                        displayValue = dt.ToString("dd.MM.yyyy HH:mm");
                        valueClass = "datetime";
                    }
                    else if (item.Value is decimal d)
                    {
                        displayValue = d.ToString("F2");
                        valueClass = "number";
                    }
                    else if (item.Value is double db)
                    {
                        displayValue = db.ToString("F2");
                        valueClass = "number";
                    }
                    else if (item.Value is int i)
                    {
                        displayValue = i.ToString();
                        valueClass = "number";
                    }
                    else if (item.Value is bool b)
                    {
                        displayValue = b ? "Да" : "Нет";
                        valueClass = "boolean";
                    }
                    else if (item.Value is string s)
                    {
                        displayValue = s;
                        valueClass = "string";
                    }
                    
                    <td class="@valueClass">@displayValue</td>
                }
            </tr>
        </table>
    </div>
}
else
{
    <div class="no-data-message">
        <i class="fas fa-database"></i>
        <p>Нет данных для отображения</p>
    </div>
}