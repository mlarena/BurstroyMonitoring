@model IEnumerable<BurstroyMonitoring.Data.Models.VwSensorErrorsFull>

@{
    ViewData["Title"] = "–û—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤";
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    var search = ViewBag.Search as string ?? "";
    var selectedSensorTypeIds = ViewBag.SelectedSensorTypeIds as List<int> ?? new List<int>();
    var selectedMonitoringPostIds = ViewBag.SelectedMonitoringPostIds as List<int> ?? new List<int>();
    var selectedSensorTypeId = ViewBag.SelectedSensorTypeId as int?;
    var selectedMonitoringPostId = ViewBag.SelectedMonitoringPostId as int?;
    
    var hasSensorTypeFilter = selectedSensorTypeId.HasValue || selectedSensorTypeIds.Any();
    var hasMonitoringPostFilter = selectedMonitoringPostId.HasValue || selectedMonitoringPostIds.Any();
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    var selectedSensorTypeNames = new List<string>();
    var selectedMonitoringPostNames = new List<string>();
    
    if (ViewBag.SensorTypes != null)
    {
        foreach (var type in ViewBag.SensorTypes)
        {
            if (selectedSensorTypeIds.Contains(type.SensorTypeId) || 
                (selectedSensorTypeId.HasValue && selectedSensorTypeId.Value == type.SensorTypeId))
            {
                selectedSensorTypeNames.Add(type.SensorTypeName);
            }
        }
    }
    
    if (ViewBag.MonitoringPosts != null)
    {
        foreach (var post in ViewBag.MonitoringPosts)
        {
            if (selectedMonitoringPostIds.Contains(post.PostId) || 
                (selectedMonitoringPostId.HasValue && selectedMonitoringPostId.Value == post.PostId))
            {
                selectedMonitoringPostNames.Add(post.Name);
            }
        }
    }
    
    var filterNamesText = "";
    if (selectedSensorTypeNames.Any())
    {
        filterNamesText += "–¢–∏–ø—ã: " + string.Join(", ", selectedSensorTypeNames);
    }
    if (selectedMonitoringPostNames.Any())
    {
        if (!string.IsNullOrEmpty(filterNamesText))
            filterNamesText += "; ";
        filterNamesText += "–ü–æ—Å—Ç—ã: " + string.Join(", ", selectedMonitoringPostNames);
    }
}

<div class="view-container">
    <h1 class="view-title">–û—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤</h1>

    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
    <div class="search-container">
        <div class="search-filters-row">
            <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
            <form method="get" class="search-form" style="flex: 1;">
                <div class="search-row">
                    <input type="text" name="search" value="@search" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é, —Ç–∏–ø—É –æ—à–∏–±–∫–∏, —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É..." 
                           class="input search-input" />
                    <button type="submit" class="button button--primary">–ù–∞–π—Ç–∏</button>
                    @if (!string.IsNullOrEmpty(search))
                    {
                        <a href="@Url.Action("Index", new { 
                            page = 1,
                            pageSize = ViewBag.PageSize,
                            selectedSensorTypes = selectedSensorTypeIds,
                            selectedMonitoringPosts = selectedMonitoringPostIds,
                            sensorTypeId = selectedSensorTypeId,
                            monitoringPostId = selectedMonitoringPostId
                        })" class="button button--secondary">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</a>
                    }
                </div>
                
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                <input type="hidden" name="sortBy" value="@ViewBag.SortBy" />
                <input type="hidden" name="sortDesc" value="@ViewBag.SortDesc.ToString()" />
                
                @if (selectedSensorTypeId.HasValue)
                {
                    <input type="hidden" name="sensorTypeId" value="@selectedSensorTypeId.Value" />
                }
                @if (selectedMonitoringPostId.HasValue)
                {
                    <input type="hidden" name="monitoringPostId" value="@selectedMonitoringPostId.Value" />
                }
                @foreach (var id in selectedSensorTypeIds)
                {
                    <input type="hidden" name="selectedSensorTypes" value="@id" />
                }
                @foreach (var id in selectedMonitoringPostIds)
                {
                    <input type="hidden" name="selectedMonitoringPosts" value="@id" />
                }
            </form>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <div class="filter-buttons" style="display: flex; gap: 8px; margin-left: 16px;">
                <!-- –§–∏–ª—å—Ç—Ä –¢–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤ -->
                <div class="filter-trigger-group">
                    <button type="button" class="button @(hasSensorTypeFilter ? "button--primary" : "button--secondary")" 
                            onclick="toggleFilter('sensorTypesFilter')">
                        –¢–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤
                        @if (hasSensorTypeFilter)
                        {
                            <span class="filter-badge">@(selectedSensorTypeIds.Count + (selectedSensorTypeId.HasValue ? 1 : 0))</span>
                        }
                    </button>
                    <div class="filter-dropdown" id="sensorTypesFilter">
                        <div class="filter-dropdown-header">
                            <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤</span>
                            <button type="button" class="filter-dropdown-close" 
                                    onclick="closeFilter('sensorTypesFilter')" title="–ó–∞–∫—Ä—ã—Ç—å">
                                ‚úï
                            </button>
                        </div>
                        <div class="checkbox-group">
                            @if (ViewBag.SensorTypes != null)
                            {
                                foreach (var type in ViewBag.SensorTypes)
                                {
                                    var isChecked = selectedSensorTypeIds.Contains(type.SensorTypeId) || 
                                                   (selectedSensorTypeId.HasValue && selectedSensorTypeId.Value == type.SensorTypeId);
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               name="selectedSensorTypes" 
                                               value="@type.SensorTypeId" 
                                               id="sensorType_@type.SensorTypeId"
                                               @(isChecked ? "checked" : "")
                                               onchange="applyFilter()" />
                                        <label for="sensorType_@type.SensorTypeId">@type.SensorTypeName</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä –ü–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
                <div class="filter-trigger-group">
                    <button type="button" class="button @(hasMonitoringPostFilter ? "button--primary" : "button--secondary")" 
                            onclick="toggleFilter('monitoringPostsFilter')">
                        –ü–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                        @if (hasMonitoringPostFilter)
                        {
                            <span class="filter-badge">@(selectedMonitoringPostIds.Count + (selectedMonitoringPostId.HasValue ? 1 : 0))</span>
                        }
                    </button>
                    <div class="filter-dropdown" id="monitoringPostsFilter">
                        <div class="filter-dropdown-header">
                            <span>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</span>
                            <button type="button" class="filter-dropdown-close" 
                                    onclick="closeFilter('monitoringPostsFilter')" title="–ó–∞–∫—Ä—ã—Ç—å">
                                ‚úï
                            </button>
                        </div>
                        <div class="checkbox-group">
                            @if (ViewBag.MonitoringPosts != null)
                            {
                                foreach (var post in ViewBag.MonitoringPosts)
                                {
                                    var isChecked = selectedMonitoringPostIds.Contains(post.PostId) || 
                                                   (selectedMonitoringPostId.HasValue && selectedMonitoringPostId.Value == post.PostId);
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               name="selectedMonitoringPosts" 
                                               value="@post.PostId" 
                                               id="post_@post.PostId"
                                               @(isChecked ? "checked" : "")
                                               onchange="applyFilter()" />
                                        <label for="post_@post.PostId">@post.Name</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                @if (hasSensorTypeFilter || hasMonitoringPostFilter || !string.IsNullOrEmpty(search))
                {
                    <a href="@Url.Action("Index", new { page = 1, pageSize = ViewBag.PageSize })" 
                       class="button button--secondary">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</a>
                }
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(filterNamesText))
        {
            <div class="active-filters-info">
                <small class="filter-info" title="@filterNamesText">
                    @filterNamesText
                </small>
            </div>
        }
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É -->
    @await Html.PartialAsync("_Pagination", new ViewDataDictionary(ViewData) {
        { "AdditionalParams", new Dictionary<string, object> {
            { "selectedSensorTypes", selectedSensorTypeIds },
            { "selectedMonitoringPosts", selectedMonitoringPostIds },
            { "sensorTypeId", selectedSensorTypeId },
            { "monitoringPostId", selectedMonitoringPostId },
            { "search", search }
        }}
    })

    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>
                        <a href="@Url.Action("Index", new { 
                            page = ViewBag.Page, 
                            pageSize = ViewBag.PageSize, 
                            search = ViewBag.Search,
                            sortBy = "ErrorId",
                            sortDesc = ViewBag.SortBy == "ErrorId" ? !ViewBag.SortDesc : true,
                            selectedSensorTypes = selectedSensorTypeIds,
                            selectedMonitoringPosts = selectedMonitoringPostIds,
                            sensorTypeId = selectedSensorTypeId,
                            monitoringPostId = selectedMonitoringPostId
                        })">
                            ID
                            @if (ViewBag.SortBy == "ErrorId")
                            {
                                <span>@(ViewBag.SortDesc ? "‚ñº" : "‚ñ≤")</span>
                            }
                        </a>
                    </th>
                    <th>–î–∞—Ç–∞ –æ—à–∏–±–∫–∏</th>
                    <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                    <th>–¢–∏–ø –¥–∞—Ç—á–∏–∫–∞</th>
                    <th>–ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</th>
                    <th>–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</th>
                    <th>–£—Ä–æ–≤–µ–Ω—å</th>
                    <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                    <th>–¢–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è</th>
                    <th>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.ErrorId</td>
                        <td>@item.ErrorCreatedAt?.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</td>
                        <td>
                            <a href="@Url.Action("Index", "SensorErrors", new { 
                                search = item.SerialNumber,
                                page = 1,
                                pageSize = ViewBag.PageSize
                            })" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ —ç—Ç–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞">
                                @item.SerialNumber
                            </a>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.SensorTypeName))
                            {
                                <a href="@Url.Action("Index", new { 
                                    sensorTypeId = item.SensorTypeId,
                                    page = 1,
                                    pageSize = ViewBag.PageSize,
                                    search = ViewBag.Search,
                                    selectedMonitoringPosts = selectedMonitoringPostIds,
                                    monitoringPostId = selectedMonitoringPostId
                                })" class="filter-link" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ç–∏–ø">
                                    @item.SensorTypeName
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">‚Äî</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.PostName))
                            {
                                <a href="@Url.Action("Index", new { 
                                    monitoringPostId = item.PostId,
                                    page = 1,
                                    pageSize = ViewBag.PageSize,
                                    search = ViewBag.Search,
                                    selectedSensorTypes = selectedSensorTypeIds,
                                    sensorTypeId = selectedSensorTypeId
                                })" class="filter-link" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø–æ—Å—Ç">
                                    @item.PostName
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">‚Äî</span>
                            }
                        </td>
                        <td>@item.EndpointName</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ErrorLevel))
                            {
                                <span class="lozenge">@item.ErrorLevel</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ErrorMessage))
                            {
                                <span title="@item.ErrorMessage">
                                    @(item.ErrorMessage.Length > 50 ? item.ErrorMessage.Substring(0, 50) + "..." : item.ErrorMessage)
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ExceptionType))
                            {
                                <span>@item.ExceptionType</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@item.ErrorId" 
                               class="button button--sm button--secondary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π">
                                üìä
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
    @await Html.PartialAsync("_Pagination", new ViewDataDictionary(ViewData) {
        { "AdditionalParams", new Dictionary<string, object> {
            { "selectedSensorTypes", selectedSensorTypeIds },
            { "selectedMonitoringPosts", selectedMonitoringPostIds },
            { "sensorTypeId", selectedSensorTypeId },
            { "monitoringPostId", selectedMonitoringPostId },
            { "search", search }
        }}
    })

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø–∏—Å–µ–π -->
    <div class="records-info">
        –ü–æ–∫–∞–∑–∞–Ω–æ @(((ViewBag.Page - 1) * ViewBag.PageSize) + 1)-@Math.Min(ViewBag.Page * ViewBag.PageSize, ViewBag.TotalCount) 
        –∏–∑ @ViewBag.TotalCount –∑–∞–ø–∏—Å–µ–π
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ –∂–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏, —á—Ç–æ –∏ –≤ SensorResults -->
<script>
    // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ –∏ –≤ SensorResults
    let activeDropdown = null;

    function toggleFilter(filterId) {
        const dropdown = document.getElementById(filterId);
        
        closeAllDropdowns();
        
        dropdown.classList.add('show');
        activeDropdown = dropdown;
        document.body.style.overflow = 'hidden';
    }

    function closeFilter(filterId) {
        const dropdown = document.getElementById(filterId);
        dropdown.classList.remove('show');
        
        if (activeDropdown === dropdown) {
            activeDropdown = null;
        }
        
        if (!document.querySelector('.filter-dropdown.show')) {
            document.body.style.overflow = '';
        }
    }

    function closeAllDropdowns() {
        document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
        
        activeDropdown = null;
        document.body.style.overflow = '';
    }

    function applyFilter() {
        const form = document.querySelector('.search-form');
        const formData = new FormData(form);
        
        const sensorTypeCheckboxes = document.querySelectorAll('input[name="selectedSensorTypes"]:checked');
        sensorTypeCheckboxes.forEach(checkbox => {
            formData.append('selectedSensorTypes', checkbox.value);
        });
        
        const monitoringPostCheckboxes = document.querySelectorAll('input[name="selectedMonitoringPosts"]:checked');
        monitoringPostCheckboxes.forEach(checkbox => {
            formData.append('selectedMonitoringPosts', checkbox.value);
        });
        
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            if (value) {
                params.append(key, value);
            }
        }
        
        params.set('page', '1');
        
        const queryString = params.toString();
        const newUrl = queryString ? '@Url.Action("Index")?' + queryString : '@Url.Action("Index")';
        
        window.location.href = newUrl;
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(event) {
            if (activeDropdown && !activeDropdown.contains(event.target) && 
                !event.target.closest('.filter-trigger-group .button')) {
                closeAllDropdowns();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllDropdowns();
            }
        });
    });
</script>

<style>
    .filter-link {
        color: #0052cc;
        text-decoration: none;
        border-bottom: 1px dashed #0052cc;
        cursor: pointer;
    }
    
    .filter-link:hover {
        color: #003d99;
        border-bottom: 1px solid #003d99;
    }
</style>