@model BurstroyMonitoring.Data.Models.VwSensorErrorsFull

@{
    ViewData["Title"] = "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ–± –æ—à–∏–±–∫–µ –¥–∞—Ç—á–∏–∫–∞";
}

<div class="details-container">
    <h1 class="form-title">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ–± –æ—à–∏–±–∫–µ –¥–∞—Ç—á–∏–∫–∞</h1>

    <div class="details-table">
        <!-- ID –æ—à–∏–±–∫–∏ -->
        <div class="details-row">
            <div class="details-label">ID –æ—à–∏–±–∫–∏</div>
            <div class="details-value">@Model.ErrorId</div>
        </div>

        <!-- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div class="details-row">
            <div class="details-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
            <div class="details-value">
                @if (Model.ErrorCreatedAt.HasValue)
                {
                    <span>@Model.ErrorCreatedAt.Value.ToString("dd.MM.yyyy HH:mm:ss")</span>
                }
                else
                {
                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                }
            </div>
        </div>

        <!-- –£—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–∫–∏ -->
        <div class="details-row">
            <div class="details-label">–£—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–∫–∏</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.ErrorLevel))
                {
                    <span class="lozenge">@Model.ErrorLevel</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –¢–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è -->
        <div class="details-row">
            <div class="details-label">–¢–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.ExceptionType))
                {
                    <span>@Model.ExceptionType</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ (–æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫—Ä–∞—Å–∏–≤–æ–º –±–ª–æ–∫–µ) -->
        <div class="details-row">
            <div class="details-label">–°–æ–æ–±—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="error-message-box">
                        @Model.ErrorMessage
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏ -->
        <div class="details-row">
            <div class="details-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.ErrorSource))
                {
                    <span>@Model.ErrorSource</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä -->
        <div class="details-row">
            <div class="details-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SerialNumber))
                {
                    <span>@Model.SerialNumber</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.EndpointName))
                {
                    <span>@Model.EndpointName</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- URL –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">URL –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SensorUrl))
                {
                    <a href="@Model.SensorUrl" target="_blank" class="highlight-link">
                        @Model.SensorUrl
                    </a>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
        <div class="details-row">
            <div class="details-label">–ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.PostName))
                {
                    <span>@Model.PostName</span>
                    @if (Model.PostIsMobile == true)
                    {
                        <span class="lozenge" style="margin-left: 8px;">–ú–æ–±–∏–ª—å–Ω—ã–π</span>
                    }
                }
                else
                {
                    <span class="text-muted">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>
                }
            </div>
        </div>

        <!-- –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–¢–∏–ø –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SensorTypeName))
                {
                    <span>@Model.SensorTypeName</span>
                    @if (!string.IsNullOrEmpty(Model.SensorTypeDescription))
                    {
                        <br />
                        <small style="color: var(--text-secondary);">@Model.SensorTypeDescription</small>
                    }
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (Model.SensorLongitude.HasValue && Model.SensorLatitude.HasValue)
                {
                    <span>@Model.SensorLongitude.Value.ToString("F6"), @Model.SensorLatitude.Value.ToString("F6")</span>
                    <br />
                    <small>
                        <a href="https://www.google.com/maps?q=@Model.SensorLatitude.Value,@Model.SensorLongitude.Value"
                           target="_blank" style="color: var(--primary-color); text-decoration: none;">
                            üìç –û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps
                        </a>
                    </small>
                }
                else
                {
                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                }
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (Model.SensorIsActive.HasValue)
                {
                    @if (Model.SensorIsActive == true)
                    {
                        <span class="lozenge lozenge--success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    }
                    else
                    {
                        <span class="lozenge lozenge--error">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    }
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON) -->
        <div class="details-row">
            <div class="details-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.AdditionalData))
                {
                    <div id="jsonContainer">
                        <button type="button" id="toggleJsonBtn" class="button button--sm button--secondary"
                                onclick="toggleJson()" style="margin-bottom: 10px;">
                            üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å JSON
                        </button>
                        <div id="jsonContent" style="display: none;">
                            <pre id="jsonCode" style="margin: 0; padding: 15px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5; max-height: 400px; overflow: auto; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; max-width: 100%; box-sizing: border-box;"></pre>
                            <button type="button" id="copyJsonBtn" class="button button--sm button--secondary"
                                    onclick="copyJson()" style="margin-top: 10px;">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Å—Ç–µ–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Å—Ç–µ–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.StackTrace))
                {
                    <div id="stackTraceContainer">
                        <button type="button" id="toggleStackTraceBtn" class="button button--sm button--secondary"
                                onclick="toggleStackTrace()" style="margin-bottom: 10px;">
                            üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É
                        </button>
                        <div id="stackTraceContent" style="display: none;">
                            <pre id="stackTraceCode" style="margin: 0; padding: 15px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ff8b00; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.5; max-height: 400px; overflow: auto; word-wrap: break-word; word-break: break-all; white-space: pre-wrap;">
                                @Model.StackTrace
                            </pre>
                            <button type="button" id="copyStackTraceBtn" class="button button--sm button--secondary"
                                    onclick="copyStackTrace()" style="margin-top: 10px;">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>
    </div>

    <div class="details-actions">
        <a asp-action="Index" class="button button--secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
</div>

@section Scripts {
    <script>
        let isJsonExpanded = false;
        let isStackTraceExpanded = false;
        let formattedJson = '';

        function syntaxHighlight(json) {
            if (!json) return '';
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("([^\\"]|\\\\")*":?|true|false|null|-?\d+(\.\d+)?([eE][+-]?\d+)?)/g, function(match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (match.endsWith(':')) cls = 'json-key';
                    else cls = 'json-string';
                } else if (/true|false/.test(match)) cls = 'json-boolean';
                else if (/null/.test(match)) cls = 'json-null';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function processJsonData() {
            const jsonData = '@Html.Raw(Model.AdditionalData?.Replace("\\", "\\\\")?.Replace("'", "\\'"))';
            if (!jsonData || jsonData === 'null' || jsonData === '""') {
                formattedJson = '// –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }

            try {
                let rawJson = jsonData;
                if (rawJson.startsWith('"') && rawJson.endsWith('"')) {
                    rawJson = rawJson.slice(1, -1);
                }
                rawJson = rawJson.replace(/\\/g, '');
                const obj = JSON.parse(rawJson);
                formattedJson = JSON.stringify(obj, null, 4);
            } catch (e) {
                formattedJson = '// –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:\n' + jsonData;
            }
        }

        function toggleJson() {
            const jsonContent = document.getElementById('jsonContent');
            const toggleBtn = document.getElementById('toggleJsonBtn');
            const jsonCode = document.getElementById('jsonCode');

            if (!isJsonExpanded) {
                if (!formattedJson) {
                    processJsonData();
                }
                jsonCode.innerHTML = syntaxHighlight(formattedJson);

                jsonCode.style.whiteSpace = 'pre-wrap';
                jsonCode.style.wordWrap = 'break-word';
                jsonCode.style.wordBreak = 'break-word';
                jsonCode.style.maxWidth = '100%';
                jsonCode.style.boxSizing = 'border-box';

                jsonContent.style.display = 'block';
                toggleBtn.textContent = 'üìÑ –°–≤–µ—Ä–Ω—É—Ç—å JSON';
                isJsonExpanded = true;
            } else {
                jsonContent.style.display = 'none';
                toggleBtn.textContent = 'üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å JSON';
                isJsonExpanded = false;
            }
        }

        function toggleStackTrace() {
            const stackTraceContent = document.getElementById('stackTraceContent');
            const toggleBtn = document.getElementById('toggleStackTraceBtn');

            if (!isStackTraceExpanded) {
                stackTraceContent.style.display = 'block';
                toggleBtn.textContent = 'üìÑ –°–≤–µ—Ä–Ω—É—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É';
                isStackTraceExpanded = true;
            } else {
                stackTraceContent.style.display = 'none';
                toggleBtn.textContent = 'üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É';
                isStackTraceExpanded = false;
            }
        }

        function copyJson() {
            if (!formattedJson) return;

            navigator.clipboard.writeText(formattedJson).then(() => {
                const copyBtn = document.getElementById('copyJsonBtn');
                const oldText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { copyBtn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON'; }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JSON:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON');
            });
        }

        function copyStackTrace() {
            const stackTraceText = document.getElementById('stackTraceCode').textContent;

            if (!stackTraceText) return;

            navigator.clipboard.writeText(stackTraceText).then(() => {
                const copyBtn = document.getElementById('copyStackTraceBtn');
                const oldText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { copyBtn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É'; }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É —Å—Ç–µ–∫–∞');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            processJsonData();

            const errorMessageDiv = document.querySelector('.error-message-box');
            if (errorMessageDiv) {
                errorMessageDiv.style.wordWrap = 'break-word';
                errorMessageDiv.style.wordBreak = 'break-word';
                errorMessageDiv.style.whiteSpace = 'normal';
            }
        });
    </script>

    <style>
        .details-table {
            display: table;
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .details-row {
            display: table-row;
        }

        .details-label,
        .details-value {
            display: table-cell;
            padding: 12px 16px;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .details-label {
            width: 240px;
            font-weight: 600;
            color: var(--text-secondary);
            background-color: #f0f4f8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .details-value {
            color: var(--text-primary);
            word-break: break-word;
        }

        /* Hover-—ç—Ñ—Ñ–µ–∫—Ç */
        .details-row:hover {
            background-color: rgba(0, 82, 204, 0.05);
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è JSON –∏ StackTrace */
        .error-message-box {
            background: #fff5f5;
            padding: 12px 16px;
            border-radius: 4px;
            border-left: 4px solid #de350b;
            word-wrap: break-word;
            word-break: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
            margin: 0;
            font-size: 14px;
        }

        pre {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            word-break: break-all !important;
            overflow-wrap: break-word !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow-x: auto !important;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
        }

        .json-key { color: #0052cc; font-weight: 600; }
        .json-string { color: #008000; }
        .json-number { color: #d73a49; }
        .json-boolean { color: #d73a49; font-weight: bold; }
        .json-null { color: #999; font-style: italic; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .button--sm {
            padding: 4px 12px;
            font-size: 13px;
        }

        .details-actions {
            margin-top: 24px;
            text-align: right;
        }

        .details-container {
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            box-sizing: border-box;
        }

      
    </style>
}