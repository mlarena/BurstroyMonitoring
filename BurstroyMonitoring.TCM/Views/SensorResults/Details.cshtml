@model BurstroyMonitoring.Data.Models.VwSensorResultsFull

@{
    ViewData["Title"] = "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—á–∏–∫–∞";
}

<div class="details-container">
    <h1 class="form-title">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—á–∏–∫–∞</h1>

    <div class="details-table">
        <!-- ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div class="details-row">
            <div class="details-label">ID —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</div>
            <div class="details-value">@Model.ResultId</div>
        </div>

        <!-- –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div class="details-row">
            <div class="details-label">–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="details-value">
                @if (Model.CheckedAt.HasValue)
                {
                    <span>@Model.CheckedAt.Value.ToString("dd.MM.yyyy HH:mm:ss")</span>
                }
                else
                {
                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                }
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div class="details-row">
            <div class="details-label">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="details-value">
                @if (Model.IsSuccess.HasValue)
                {
                    @if (Model.IsSuccess == true)
                    {
                        <span class="lozenge lozenge--success">–£—Å–ø–µ—à–Ω–æ</span>
                    }
                    else
                    {
                        <span class="lozenge lozenge--error">–û—à–∏–±–∫–∞</span>
                    }
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ HTTP -->
        <div class="details-row">
            <div class="details-label">–ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ HTTP</div>
            <div class="details-value">
                @if (Model.StatusCode.HasValue)
                {
                    <span>@Model.StatusCode</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ -->
        <div class="details-row">
            <div class="details-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
            <div class="details-value">
                @if (Model.ResponseTimeMs.HasValue)
                {
                    <span>@Model.ResponseTimeMs.Value.ToString("N0") –º—Å</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä -->
        <div class="details-row">
            <div class="details-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SerialNumber))
                {
                    <span>@Model.SerialNumber</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.EndpointName))
                {
                    <span>@Model.EndpointName</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- URL –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">URL –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SensorUrl))
                {
                    <a href="@Model.SensorUrl" target="_blank" class="highlight-link">
                        @Model.SensorUrl
                    </a>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
        <div class="details-row">
            <div class="details-label">–ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.PostName))
                {
                    <span>@Model.PostName</span>
                    @if (Model.PostIsMobile == true)
                    {
                        <span class="lozenge" style="margin-left: 8px;">–ú–æ–±–∏–ª—å–Ω—ã–π</span>
                    }
                }
                else
                {
                    <span class="text-muted">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>
                }
            </div>
        </div>

        <!-- –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–¢–∏–ø –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.SensorTypeName))
                {
                    <span>@Model.SensorTypeName</span>
                    @if (!string.IsNullOrEmpty(Model.SensorTypeDescription))
                    {
                        <br />
                        <small style="color: var(--text-secondary);">@Model.SensorTypeDescription</small>
                    }
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (Model.SensorLongitude.HasValue && Model.SensorLatitude.HasValue)
                {
                    <span>@Model.SensorLongitude.Value.ToString("F6"), @Model.SensorLatitude.Value.ToString("F6")</span>
                    <br />
                    <small>
                        <a href="https://www.google.com/maps?q=@Model.SensorLatitude.Value,@Model.SensorLongitude.Value"
                           target="_blank" style="color: var(--primary-color); text-decoration: none;">
                            üìç –û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps
                        </a>
                    </small>
                }
                else
                {
                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                }
            </div>
        </div>

        <!-- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div class="details-row">
            <div class="details-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="details-value">
                @if (Model.CheckIntervalSeconds.HasValue)
                {
                    <span>@Model.CheckIntervalSeconds —Å–µ–∫—É–Ω–¥</span>
                    <small style="color: var(--text-secondary); margin-left: 8px;">
                        (@(Model.CheckIntervalSeconds / 60) –º–∏–Ω—É—Ç)
                    </small>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
        <div class="details-row">
            <div class="details-label">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            <div class="details-value">
                @if (Model.LastActivityUtc.HasValue)
                {
                    <span>@Model.LastActivityUtc.Value.ToString("dd.MM.yyyy HH:mm:ss") UTC</span>
                    <br />
                    <small style="color: var(--text-secondary);">
                        @{
                            var timeAgo = DateTime.UtcNow - Model.LastActivityUtc.Value;
                            if (timeAgo.TotalDays >= 1)
                            {
                                <span>@((int)timeAgo.TotalDays) –¥–Ω–µ–π –Ω–∞–∑–∞–¥</span>
                            }
                            else if (timeAgo.TotalHours >= 1)
                            {
                                <span>@((int)timeAgo.TotalHours) —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥</span>
                            }
                            else if (timeAgo.TotalMinutes >= 1)
                            {
                                <span>@((int)timeAgo.TotalMinutes) –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥</span>
                            }
                            else
                            {
                                <span>–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
                            }
                        }
                    </small>
                }
                else
                {
                    <span class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                }
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞ -->
        <div class="details-row">
            <div class="details-label">–°—Ç–∞—Ç—É—Å –¥–∞—Ç—á–∏–∫–∞</div>
            <div class="details-value">
                @if (Model.SensorIsActive.HasValue)
                {
                    @if (Model.SensorIsActive == true)
                    {
                        <span class="lozenge lozenge--success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    }
                    else
                    {
                        <span class="lozenge lozenge--error">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    }
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        <!-- –û—Ç–≤–µ—Ç (JSON) -->
        <div class="details-row">
            <div class="details-label">–û—Ç–≤–µ—Ç (JSON)</div>
            <div class="details-value">
                @if (!string.IsNullOrEmpty(Model.ResponseBody))
                {
                    <div id="jsonContainer">
                        <button type="button" id="toggleJsonBtn" class="button button--sm button--secondary"
                                onclick="toggleJson()" style="margin-bottom: 10px;">
                            üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å JSON
                        </button>
                        <div id="jsonContent" style="display: none;">
                            <pre id="jsonCode" style="margin: 0; padding: 15px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.5; max-height: 400px; overflow: auto; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; max-width: 100%; box-sizing: border-box;"></pre>
                            <button type="button" id="copyJsonBtn" class="button button--sm button--secondary"
                                    onclick="copyJson()" style="margin-top: 10px;">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>
    </div>

    <div class="details-actions">
        <a asp-action="Index" class="button button--secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
</div>

@section Scripts {
    <script>
        let isJsonExpanded = false;
        let formattedJson = '';

        function syntaxHighlight(json) {
            if (!json) return '';
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("([^\\"]|\\\\")*":?|true|false|null|-?\d+(\.\d+)?([eE][+-]?\d+)?)/g, function(match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (match.endsWith(':')) cls = 'json-key';
                    else cls = 'json-string';
                } else if (/true|false/.test(match)) cls = 'json-boolean';
                else if (/null/.test(match)) cls = 'json-null';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function processJsonData() {
            const jsonData = '@Html.Raw(Model.ResponseBody?.Replace("\\", "\\\\")?.Replace("'", "\\'"))';
            if (!jsonData || jsonData === 'null' || jsonData === '""') {
                formattedJson = '// –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                return;
            }

            try {
                let rawJson = jsonData;
                if (rawJson.startsWith('"') && rawJson.endsWith('"')) {
                    rawJson = rawJson.slice(1, -1);
                }
                rawJson = rawJson.replace(/\\/g, '');
                const obj = JSON.parse(rawJson);
                formattedJson = JSON.stringify(obj, null, 4);
            } catch (e) {
                formattedJson = '// –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:\n' + jsonData;
            }
        }

        function toggleJson() {
            const jsonContent = document.getElementById('jsonContent');
            const toggleBtn = document.getElementById('toggleJsonBtn');
            const jsonCode = document.getElementById('jsonCode');

            if (!isJsonExpanded) {
                if (!formattedJson) {
                    processJsonData();
                }
                jsonCode.innerHTML = syntaxHighlight(formattedJson);

                jsonContent.style.display = 'block';
                toggleBtn.textContent = 'üìÑ –°–≤–µ—Ä–Ω—É—Ç—å JSON';
                isJsonExpanded = true;
            } else {
                jsonContent.style.display = 'none';
                toggleBtn.textContent = 'üìÑ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å JSON';
                isJsonExpanded = false;
            }
        }

        function copyJson() {
            if (!formattedJson) return;

            navigator.clipboard.writeText(formattedJson).then(() => {
                const copyBtn = document.getElementById('copyJsonBtn');
                const oldText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { copyBtn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON'; }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JSON:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            processJsonData();
        });
    </script>
}