@model IEnumerable<BurstroyMonitoring.Data.Models.VwSensorResultsFull>

@{
    ViewData["Title"] = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–∞—Ç—á–∏–∫–æ–≤";
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    var search = ViewBag.Search as string ?? "";
    var selectedSensorTypeIds = ViewBag.SelectedSensorTypeIds as List<int> ?? new List<int>();
    var selectedMonitoringPostIds = ViewBag.SelectedMonitoringPostIds as List<int> ?? new List<int>();
    var selectedSensorTypeId = ViewBag.SelectedSensorTypeId as int?;
    var selectedMonitoringPostId = ViewBag.SelectedMonitoringPostId as int?;
    
    var hasSensorTypeFilter = selectedSensorTypeId.HasValue || selectedSensorTypeIds.Any();
    var hasMonitoringPostFilter = selectedMonitoringPostId.HasValue || selectedMonitoringPostIds.Any();
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    var selectedSensorTypeNames = new List<string>();
    var selectedMonitoringPostNames = new List<string>();
    
    if (ViewBag.SensorTypes != null)
    {
        foreach (var type in ViewBag.SensorTypes)
        {
            if (selectedSensorTypeIds.Contains(type.SensorTypeId) || 
                (selectedSensorTypeId.HasValue && selectedSensorTypeId.Value == type.SensorTypeId))
            {
                selectedSensorTypeNames.Add(type.SensorTypeName);
            }
        }
    }
    
    if (ViewBag.MonitoringPosts != null)
    {
        foreach (var post in ViewBag.MonitoringPosts)
        {
            if (selectedMonitoringPostIds.Contains(post.PostId) || 
                (selectedMonitoringPostId.HasValue && selectedMonitoringPostId.Value == post.PostId))
            {
                selectedMonitoringPostNames.Add(post.Name);
            }
        }
    }
    
    var filterNamesText = "";
    if (selectedSensorTypeNames.Any())
    {
        filterNamesText += "–¢–∏–ø—ã: " + string.Join(", ", selectedSensorTypeNames);
    }
    if (selectedMonitoringPostNames.Any())
    {
        if (!string.IsNullOrEmpty(filterNamesText))
            filterNamesText += "; ";
        filterNamesText += "–ü–æ—Å—Ç—ã: " + string.Join(", ", selectedMonitoringPostNames);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ñ–∏–ª—å—Ç—Ä–∞
    bool IsSensorTypeActive(int typeId)
    {
        return selectedSensorTypeIds.Contains(typeId) || 
               (selectedSensorTypeId.HasValue && selectedSensorTypeId.Value == typeId);
    }
    
    bool IsMonitoringPostActive(int postId)
    {
        return selectedMonitoringPostIds.Contains(postId) || 
               (selectedMonitoringPostId.HasValue && selectedMonitoringPostId.Value == postId);
    }
}

<div class="view-container">
    <h1 class="view-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–∞—Ç—á–∏–∫–æ–≤</h1>

    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
    <div class="search-container">
        <div class="search-filters-row">
            <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ -->
            <form method="get" class="search-form" style="flex: 1;" action="@Url.Action("Index")">
                <div class="search-row">
                    <input type="text" name="search" value="@search" 
                           placeholder="–ü–æ–∏—Å–∫ ..." 
                           class="input search-input" />
                    <button type="submit" class="button button--primary">–ù–∞–π—Ç–∏</button>
                    @if (!string.IsNullOrEmpty(search))
                    {
                        <button type="button" onclick="resetAllFilters('@Url.Action("Index", new { page = 1, pageSize = ViewBag.PageSize })')" class="button button--secondary">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫</button>
                    }
                    
                    <label style="display: inline-flex; align-items: center; gap: 8px; margin-left: 16px; cursor: pointer;">
                        <input type="checkbox" id="autoRefresh" style="width: 16px; height: 16px; margin: 0; accent-color: #0052cc;" />
                        <label>–û–±–Ω–æ–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</label>
                    </label>
                </div>
                
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                <input type="hidden" name="sortBy" value="@ViewBag.SortBy" />
                <input type="hidden" name="sortDesc" value="@ViewBag.SortDesc.ToString()" />
                
                @if (selectedSensorTypeId.HasValue)
                {
                    <input type="hidden" name="sensorTypeId" value="@selectedSensorTypeId.Value" />
                }
                @if (selectedMonitoringPostId.HasValue)
                {
                    <input type="hidden" name="monitoringPostId" value="@selectedMonitoringPostId.Value" />
                }
                @foreach (var id in selectedSensorTypeIds)
                {
                    <input type="hidden" name="selectedSensorTypes" value="@id" />
                }
                @foreach (var id in selectedMonitoringPostIds)
                {
                    <input type="hidden" name="selectedMonitoringPosts" value="@id" />
                }
            </form>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <div class="filter-buttons" style="display: flex; gap: 8px; margin-left: 16px;">

                <!-- –§–∏–ª—å—Ç—Ä –ü–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
                <div class="filter-trigger-group">
                    <button type="button" class="button @(hasMonitoringPostFilter ? "button--primary" : "button--secondary")" 
                            onclick="toggleFilter('monitoringPostsFilter')">
                        –ü–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                        @if (hasMonitoringPostFilter)
                        {
                            <span class="filter-badge">@(selectedMonitoringPostIds.Count + (selectedMonitoringPostId.HasValue ? 1 : 0))</span>
                        }
                    </button>
                    <div class="filter-dropdown" id="monitoringPostsFilter">
                        <div class="filter-dropdown-header">
                            <span>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</span>
                            <button type="button" class="filter-dropdown-close" 
                                    onclick="closeFilter('monitoringPostsFilter')" title="–ó–∞–∫—Ä—ã—Ç—å">
                                ‚úï
                            </button>
                        </div>
                        <div class="checkbox-group">
                            @if (ViewBag.MonitoringPosts != null)
                            {
                                foreach (var post in ViewBag.MonitoringPosts)
                                {
                                    var isChecked = IsMonitoringPostActive(post.PostId);
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               name="selectedMonitoringPosts" 
                                               value="@post.PostId" 
                                               id="post_@post.PostId"
                                               @(isChecked ? "checked" : "")
                                               onchange="applyFilter()" />
                                        <label for="post_@post.PostId">@post.Name</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä –¢–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤ -->
                <div class="filter-trigger-group">
                    <button type="button" class="button @(hasSensorTypeFilter ? "button--primary" : "button--secondary")" 
                            onclick="toggleFilter('sensorTypesFilter')">
                        –¢–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤
                        @if (hasSensorTypeFilter)
                        {
                            <span class="filter-badge">@(selectedSensorTypeIds.Count + (selectedSensorTypeId.HasValue ? 1 : 0))</span>
                        }
                    </button>
                    <div class="filter-dropdown" id="sensorTypesFilter">
                        <div class="filter-dropdown-header">
                            <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã –¥–∞—Ç—á–∏–∫–æ–≤</span>
                            <button type="button" class="filter-dropdown-close" 
                                    onclick="closeFilter('sensorTypesFilter')" title="–ó–∞–∫—Ä—ã—Ç—å">
                                ‚úï
                            </button>
                        </div>
                        <div class="checkbox-group">
                            @if (ViewBag.SensorTypes != null)
                            {
                                foreach (var type in ViewBag.SensorTypes)
                                {
                                    var isChecked = IsSensorTypeActive(type.SensorTypeId);
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               name="selectedSensorTypes" 
                                               value="@type.SensorTypeId" 
                                               id="sensorType_@type.SensorTypeId"
                                               @(isChecked ? "checked" : "")
                                               onchange="applyFilter()" />
                                        <label for="sensorType_@type.SensorTypeId">@type.SensorTypeName</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                @if (hasSensorTypeFilter || hasMonitoringPostFilter || !string.IsNullOrEmpty(search))
                {
                    <button type="button" onclick="resetAllFilters('@Url.Action("Index", new { page = 1, pageSize = ViewBag.PageSize })')" class="button button--secondary">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
                }
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(filterNamesText))
        {
            <div class="active-filters-info">
                <small class="filter-info" title="@filterNamesText">
                    @filterNamesText
                </small>
            </div>
        }
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É -->
    @await Html.PartialAsync("_Pagination", new ViewDataDictionary(ViewData) {
        { "AdditionalParams", new Dictionary<string, object> {
            { "selectedSensorTypes", selectedSensorTypeIds },
            { "selectedMonitoringPosts", selectedMonitoringPostIds },
            { "sensorTypeId", selectedSensorTypeId },
            { "monitoringPostId", selectedMonitoringPostId },
            { "search", search }
        }}
    })

    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>
                        <a href="@Url.Action("Index", new { 
                            page = ViewBag.Page, 
                            pageSize = ViewBag.PageSize, 
                            search = ViewBag.Search,
                            sortBy = "ResultId",
                            sortDesc = ViewBag.SortBy == "ResultId" ? !ViewBag.SortDesc : true,
                            selectedSensorTypes = selectedSensorTypeIds,
                            selectedMonitoringPosts = selectedMonitoringPostIds,
                            sensorTypeId = selectedSensorTypeId,
                            monitoringPostId = selectedMonitoringPostId
                        })">
                            ID
                            @if (ViewBag.SortBy == "ResultId")
                            {
                                <span>@(ViewBag.SortDesc ? "‚ñº" : "‚ñ≤")</span>
                            }
                        </a>
                    </th>
                    <th>–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
                    <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                    <th>–¢–∏–ø –¥–∞—Ç—á–∏–∫–∞</th>
                    <th>–ü–æ—Å—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</th>
                    <th>–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞</th>
                    <th>–ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞</th>
                    <th>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.ResultId</td>
                        <td>@item.CheckedAt?.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss")</td>
                        <td>
                            <a href="@Url.Action("Index", "SensorResults", new { 
                                search = item.SerialNumber,
                                page = 1,
                                pageSize = ViewBag.PageSize
                            })" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç—Ç–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞">
                                @item.SerialNumber
                            </a>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.SensorTypeName))
                            {
                                var isActive = IsSensorTypeActive(item.SensorTypeId.Value);
                                <a href="javascript:void(0);"
                                   onclick="toggleFilterItem('sensorType', '@item.SensorTypeId')"
                                   class="filter-link @(isActive ? "filter-link--active" : "")"
                                   title="@(isActive ? "–£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–æ–º—É —Ç–∏–ø—É" : "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ç–∏–ø")">
                                    @item.SensorTypeName
                                    @if (isActive)
                                    {
                                        <span class="filter-active-indicator">‚úì</span>
                                    }
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">‚Äî</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.PostName))
                            {
                                var isActive = IsMonitoringPostActive(item.PostId.Value);
                                <a href="javascript:void(0);"
                                   onclick="toggleFilterItem('monitoringPost', '@item.PostId')"
                                   class="filter-link @(isActive ? "filter-link--active" : "")"
                                   title="@(isActive ? "–£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É" : "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø–æ—Å—Ç")">
                                    @item.PostName
                                    @if (isActive)
                                    {
                                        <span class="filter-active-indicator">‚úì</span>
                                    }
                                </a>
                            }
                            else
                            {
                                <span class="text-muted">‚Äî</span>
                            }
                        </td>
                        <td>@item.EndpointName</td>
                        <td>
                            @if (item.StatusCode.HasValue)
                            {
                                <span>@item.StatusCode</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (item.ResponseTimeMs.HasValue)
                            {
                                <span>@item.ResponseTimeMs.Value.ToString("N0") –º—Å</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (item.IsSuccess.HasValue)
                            {
                                @if (item.IsSuccess == true)
                                {
                                    <span class="lozenge lozenge--success">–£—Å–ø–µ—à–Ω–æ</span>
                                }
                                else
                                {
                                    <span class="lozenge lozenge--error">–û—à–∏–±–∫–∞</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@item.ResultId" 
                               class="button button--sm button--secondary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π">
                                üìä
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
    @await Html.PartialAsync("_Pagination", new ViewDataDictionary(ViewData) {
        { "AdditionalParams", new Dictionary<string, object> {
            { "selectedSensorTypes", selectedSensorTypeIds },
            { "selectedMonitoringPosts", selectedMonitoringPostIds },
            { "sensorTypeId", selectedSensorTypeId },
            { "monitoringPostId", selectedMonitoringPostId },
            { "search", search }
        }}
    })

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø–∏—Å–µ–π -->
    <div class="records-info">
        –ü–æ–∫–∞–∑–∞–Ω–æ @(((ViewBag.Page - 1) * ViewBag.PageSize) + 1)-@Math.Min(ViewBag.Page * ViewBag.PageSize, ViewBag.TotalCount) 
        –∏–∑ @ViewBag.TotalCount –∑–∞–ø–∏—Å–µ–π
    </div>
</div>

<style>
    .filter-link {
        color: #0052cc;
        text-decoration: none;
        border-bottom: 1px dashed #0052cc;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .filter-link:hover {
        color: #003d99;
        border-bottom: 1px solid #003d99;
    }
    
    .filter-link--active {
        color: #28a745;
        border-bottom-color: #28a745;
        font-weight: 500;
    }
    
    .filter-link--active:hover {
        color: #218838;
        border-bottom-color: #218838;
    }
    
    .filter-active-indicator {
        font-size: 12px;
        margin-left: 2px;
    }
</style>

@section Scripts {
    
    <script src="~/js/autoRefresh.js"></script>
    <script src="~/js/filter.js"></script>
}