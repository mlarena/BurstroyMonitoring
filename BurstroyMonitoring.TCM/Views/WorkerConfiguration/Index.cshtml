@model IEnumerable<BurstroyMonitoring.Data.Models.WorkerConfigEditViewModel>
@{
    ViewData["Title"] = "Настройки Worker'ов";
}

<div class="view-container">
    <h1 class="view-title">@ViewData["Title"]</h1>
    
    <!-- Сообщения об успехе/ошибке -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert-success" style="padding: 10px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
            @TempData["SuccessMessage"]
        </div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert-warning" style="padding: 10px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #ffc107;">
            @TempData["ErrorMessage"]
        </div>
    }

    <!-- Таблица конфигураций -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Ключ</th>
                    <th>Значение</th>
                    <th>Тип</th>
                    <th>Описание</th>
                    <th>Изменено</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td><strong>@item.Key</strong></td>
                        <td>
                            <form asp-action="Edit" method="post" class="inline-form">
                                <input type="hidden" name="id" value="@item.Id" />
                                @Html.AntiForgeryToken()
                                
                                @if (item.IsBoolean)
                                {
                                    <select name="value" class="input input--sm select" onchange="this.form.submit()">
                                        <option value="true" selected="@(item.Value == "true")">true</option>
                                        <option value="false" selected="@(item.Value == "false")">false</option>
                                    </select>
                                }
                                else if (item.IsInteger)
                                {
                                    <input type="number" name="value" value="@item.Value" 
                                           class="input input--sm" 
                                           onblur="if(this.value.trim() !== '@item.Value') this.form.submit()" />
                                }
                                else if (item.IsDecimal)
                                {
                                    <input type="number" step="0.01" name="value" value="@item.Value" 
                                           class="input input--sm" 
                                           onblur="if(this.value.trim() !== '@item.Value') this.form.submit()" />
                                }
                                else if (item.IsJson)
                                {
                                    <button type="button" class="button button--sm button--secondary" 
                                            onclick="editJson(@item.Id, '@item.Key', '@Html.Raw(item.Value.Replace("'", "\\'"))')">
                                        Редактировать JSON
                                    </button>
                                    <input type="hidden" id="json-@item.Id" name="value" value="@item.Value" />
                                }
                                else
                                {
                                    <input type="text" name="value" value="@item.Value" 
                                           class="input input--sm" 
                                           onblur="if(this.value.trim() !== '@item.Value') this.form.submit()" />
                                }
                            </form>
                        </td>
                        <td><span class="lozenge">@item.DataType</span></td>
                        <td><small style="color: var(--text-secondary);">@item.Description</small></td>
                        <td><small>@item.ModifiedBy<br/>@item.LastModified.ToString("dd.MM.yyyy HH:mm")</small></td>
                        <td>
                            @if (item.IsActive)
                            {
                                <span class="lozenge lozenge--success">✓</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно для редактирования JSON -->
<div class="modal-overlay" id="jsonModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Редактирование JSON</h3>
            <button type="button" class="modal-close" onclick="closeJsonModal()">×</button>
        </div>
        <div class="modal-body">
            <textarea id="jsonEditor" class="input" rows="10" style="font-family: monospace; width: 100%;"></textarea>
            <div id="jsonError" class="text-danger mt-2" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="button button--secondary" onclick="closeJsonModal()">Отмена</button>
            <button type="button" class="button button--primary" onclick="saveJson()">Сохранить</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let editingJsonId = null;
        let originalJsonValue = null;
        
        function editJson(id, key, value) {
            editingJsonId = id;
            originalJsonValue = value;
            
            // Форматируем JSON для удобного чтения
            try {
                const parsed = JSON.parse(value);
                document.getElementById('jsonEditor').value = JSON.stringify(parsed, null, 2);
            } catch {
                document.getElementById('jsonEditor').value = value;
            }
            
            document.getElementById('jsonError').style.display = 'none';
            document.getElementById('jsonModal').style.display = 'flex';
        }
        
        function closeJsonModal() {
            document.getElementById('jsonModal').style.display = 'none';
            editingJsonId = null;
            originalJsonValue = null;
        }
        
        function saveJson() {
            const jsonText = document.getElementById('jsonEditor').value;
            
            try {
                // Проверяем валидность JSON
                JSON.parse(jsonText);
                
                // Сохраняем значение в скрытое поле
                document.getElementById(`json-${editingJsonId}`).value = jsonText;
                
                // Отправляем форму
                const form = document.querySelector(`form input[value="${editingJsonId}"]`).closest('form');
                form.submit();
            } catch (error) {
                document.getElementById('jsonError').textContent = 'Ошибка JSON: ' + error.message;
                document.getElementById('jsonError').style.display = 'block';
            }
        }
        
        // Закрытие модального окна по клику вне его
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('jsonModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeJsonModal();
                }
            });
            
            // Закрытие по Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    closeJsonModal();
                }
            });
        });
    </script>
    
    <style>
        .inline-form {
            display: inline;
            margin: 0;
            padding: 0;
        }
        
        .input--sm {
            max-width: 200px;
            padding: 4px 8px;
            font-size: 14px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        select.input {
            appearance: auto;
            cursor: pointer;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
    </style>
}